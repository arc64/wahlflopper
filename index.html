<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <title>Wahlflopper</title>
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">

	<!-- Optional theme -->
	<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css">

	<link rel="stylesheet" href="css/style.css" type="text/css"
	medium="screen" />
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Friedrich Lindenberg" />

    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0-rc1/css/bootstrap.min.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700' rel='stylesheet' type='text/css'>


	<style>

		#skeleton {
			display: none;
		}

		.videos {
			margin: 4em auto;
			position: relative
		}

		.layer {
			position: absolute;
			top: 0;
			left: 0;
			display: none;
			width: 500px;
			height: 400px;
		}

		.jumbotron h1 {
			font-size: 38px;
		}
  		
  		#sortable li { }
  
  		.row {
  			margin-left: -6px;
  		}

  		.panel-body {
			padding: 0;
		}

		li { 
			cursor: pointer;
		}

		.mixer img {
            width: 110px;
		}
  
  		.play-video {
			display: block;
			overflow: auto;
			margin: 0;
			padding: 0;
  		}

  		.play {
  			position:absolute;
		    top:0;
		    left:0;
		    right:0;
		    bottom:0;
		    background-color: rgba(0, 0, 0, 0.6);
		    background: url(data:;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAABl0RVh0U29mdHdhcmUAUGFpbnQuTkVUIHYzLjUuNUmK/OAAAAATSURBVBhXY2RgYNgHxGAAYuwDAA78AjwwRoQYAAAAAElFTkSuQmCC) repeat scroll transparent\9; /* ie fallback png background image */
		    z-index:9999;
		    color:white;
		    line-height: 3em;
			font-size: 40px;
		    text-align: center;
  		}

  		.picker .video {
  			position: abosolute;
  		}

  		.picker .add {
  			margin-left: 10px;
  		}
	</style>
  	<!-- Latest compiled and minified JavaScript -->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="../../assets/js/html5shiv.js"></script>
      <script src="../../assets/js/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="jumbotron">
      <div class="container">
      	<div class="page-header">
  			<h1>Wahlflopper <small>Remix your BTW13 election defeat videos here</small></h1>
		</div>
        <div class="panel panel-default">
		  <div class="panel-heading">Mixer</div>
		  <div class="panel-body mixer">
		  	<div class="row">
		    	<ul id="sortable" class="list-unstyled list-inline">
		    	</ul>
	    	</div>
	    	<a data-toggle="modal" href="#myModal" class="btn-success btn-lg pull-right"><span class=" glyphicon glyphicon-play"></span><!-- Play your remix! --></a>
		  </div>
		</div>
      </div>
    </div>

    <div class="videos container">
      <div class="row">
        <div class="picker">
          
        </div>
      </div>
      <hr>

      <footer>
        <p>Code can be found <a href="https://github.com/arc64/wahlflopper">on github</a></p>
      </footer>
    </div> <!-- /container -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0/handlebars.min.js"></script>
	<!-- todo: boot load videos 
			drag and drop
	-->
	<script src="http://popcornjs.org/code/dist/popcorn-complete.min.js"></script>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

    <script>
    $(function() {

    // some hairy user interaction
	    // $( ".draggable" ).draggable();
	    // $( "#droppable" ).droppable({
	    //   drop: function( event, ui ) {
	    //     $( this )
	    //       .addClass( "panel-success" );
	    //   }
	    // });
  
  

  		// data for videos
    	var inMixer = ['zur-tagesordnung', 'bittere-cdu'];

		var clips = {'items':{
		  	'zur-tagesordnung': {
		  	id: 'zur-tagesordnung',
            title: 'zur Tagesordnung übergehen',
            yt: 'gMp2D9rBiSc',
            in: 233,
            out: 240
          },
          'bittere-cdu': {
          	id: 'bittere-cdu',
            title: 'eine bittere Niederlage',
            yt: 'I-3G0ylRriQ',
            in: 22,
            out: 29
          },
          'jfk-bin-ein-berliner': {
          	id: 'jfk-bin-ein-berliner',
            title: 'ich bin ein Berliner',
            yt: 'hH6nQhss4Yc',
            in: 21,
            out: 23.5
          },
          'ruckrede': {
          	id: 'ruckrede',
            title: 'liebgewonnene Besitzstände',
            yt: 'FhHrzWvd-Js',
            in: 0,
            out: 2.5
          },
          'herzchen': {
          	id: 'herzchen',
            title: 'sozialdemokratische Herzen',
            yt: '8FZIlXVhWIk',
            in: 90.5,
            out: 96.5
          },
          'umfassend': {
          	id: 'umfassend',
            title: 'eindeutig und umfassend',
            yt: 'wKA7GwTuVJA',
            in: 32.5,
            out: 40.5
          },
          'angieschmerz': {
          	id: 'angieschmerz',
            title: 'schmerzt natürlich sehr',
            yt: 'rR35QbUS1WU',
            in: 48,
            out: 55
          },
          'mickey': {
          	id: 'mickey',
            title: 'Knockout! ',
            yt: 'kT_pS_4OO7E',
            in: 234,
            out: 240
          },
          'hauptstadtchefin': {
          	id: 'hauptstadtchefin',
            title: 'als ZDF-Hauptstadtchefin',
            yt: 'ssHU_-wpsMo',
            in: 263,
            out: 266.5
          }
		}};

		// some method madness
		function removeItemFromMixer(id) {
			inMixer = $.grep(inMixer, function(e){ return e != id; });
			$('body').data('videoid', id).removeClass('inMixer');
    	}

    	function addItemToMixer(id, index) {
    		inMixer.splice(index, 0, id);
    		// console.log(inMixer)
    		$('body').data('videoid', id).addClass('inMixer');
    	}

    	function getItem(id) {
    		return $.grep(inMixer, function(e){ return e == id; });
    	}

    	// templates
		var videoTemplate = ['{{#items}}<li data-videoid="{{id}}" class="video col-2 col-sm-2 col-lg-2">',
			'<div class="panel panel-default">',
		        '<div class="panel-heading">',
		        '<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>',
		          '<h3 class="panel-title">{{index}}. {{title}}</h3>',
		          
				'</div>',
		        '<div class="panel-body">',
		          // '<a href="#" class="thumbnail">',
				      '<img src="http://img.youtube.com/vi/{{yt}}/mqdefault.jpg" alt="{{title}}">',
				   // '</a>',
		        '</div>',
	      	'</div>',
	    '</li>{{/items}}'].join('');


	    var modelTemplate = [
	    '<!-- Modal -->',
		'<div class="modal fade">',
		'<div class="modal-dialog">',
		'<div class="modal-content">',
		'<div class="modal-header">',
		'<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>',
		'<h4 class="modal-title">{{title}}</h4>',
		'</div>',
		'<div id="skeleton" class="modal-body">',
        '<div class="layer">',
		'{{embed}}',
		'</div>',
		'</div>',
		'<div class="modal-footer">',
		'<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>',
		'<button type="button" class="btn btn-primary">Save changes</button>',
		'</div>',
		'</div><!-- /.modal-content -->',
		'</div><!-- /.modal-dialog -->',
		'</div><!-- /.modal -->'
    	].join('');

    	var pickerTemplate = '{{#each items}}<div class="video col-md-6" data-videoid={{id}}><h3>{{title}}</h3><a href="#" class="play-video col-md-6"><span class="play glyphicon glyphicon-play"></span><img src="http://img.youtube.com/vi/{{yt}}/mqdefault.jpg" class="img-responsive" /></a><a href="#" type="button" class="btn btn-success add"><span class="glyphicon glyphicon-plus"></span></a></div>{{/each}}';

	    function renderMixer(){
	    	var videos = {};
	    	videos['items'] = [];
	    	$.each( inMixer, function(i, value) {
	    		// todo : more elegant way of doing this
	    		var tmp = clips['items'][value];
	    		tmp['index'] = i+1;
	    		console.log(tmp)
 				videos['items'].push(tmp);	
			});
			var template = Handlebars.compile(videoTemplate);
			$('.mixer #sortable').html(template(videos));
	    	return;
	    }

	    function renderModel(){
	    	var video = 0;// todo: popcorn 
	    	var template = Handlebars.compile(modelTemplate);
	    	$('.body').append(template(video));
	    	return;
	    }

		function renderPicker(){
			var template = Handlebars.compile(pickerTemplate);
		
			$('.picker').append(template(clips));
		}

		// getting down to business
		// render some stuff
		renderMixer(); 
		renderPicker();
		//renderModal();

		// event heaven


		$('.mixer').delegate( ".close", "click", function(e) {
			vId = $(this).closest('.video').data('videoid');
			removeItemFromMixer(vId); 
		 	renderMixer(); 
		 	//updateURI();
		});

		$('.picker').delegate( ".add", "click", function(e) {
			vId = $(this).closest('.video').data('videoid');
			addItemToMixer(vId, inMixer.length); 
		 	renderMixer(); 

		 	//updateURI();
		});

		// $('.glyphicon-play').click(function(){
		// 	//var urli = //resolve items;
		// 	// open modal and play video

		// });

// todo: smallify for mobile
// todo: add items from list
// todo: create list
// todo: cursor to grab / plus state indicator
// todo: hash for url
// todo: remix or share
// todo: make shit fade in and show user where they are
// todo: now that you ahve changed to hanlebars change the templates
		$( "#sortable" ).sortable({
      		placeholder: "video",
  			stop: function(event, ui) {
  				var id = ui.item.data('videoid');
  				var item = getItem(id);
  				removeItemFromMixer(id);
  				addItemToMixer(id, item[0], ui.item.index());
		    }
    	});



    	// Popcorn playback

    	 
    	// var skeleton = $('#skeleton').html(),
     //    $videos = $('.videos');
     //    $.each(clips, function(k, v) {
     //      $el = $(skeleton);
     //      $el.prop('id', k);
     //      $videos.append($el);
     //      v.$el = $el;
     //      v.pc = Popcorn.youtube('#' + k, 'http://www.youtube.com/watch?autoplay=0&v=' + v.yt);
     //      v.pc.pause();
     //      v.pc.autoplay(false);
     //      v.pc.on('loadedmetadata', function() {
     //        v.pc.currentTime(v.in);
     //        //
     //      });
     //    });

        //var sequence = ['zur-tagesordnung', 'bittere-cdu', 'jfk-bin-ein-berliner'];  'bittere-cdu', 
        var sequence = ['ruckrede', 'mickey', 'angieschmerz', 'zur-tagesordnung', 'jfk-bin-ein-berliner', 'herzchen', 'hauptstadtchefin'];

        function playback(sequence, doneCallback) {
          var k = sequence[0],
              v = clips[k];
          v.$el.show();
          //v.pc.currentTime();
          v.pc.unmute();
          v.pc.play(v.in);
          v.pc.cue(v.out, function() {
            v.pc.pause();
            v.$el.hide();
            var rem = sequence.slice(1);
            if (!rem.length) doneCallback();
            playback(rem, doneCallback);
            //console.log(rem);
          });
        }
        
        //window.seq = sequence;
        //window.playback = playback;
        //playback(sequence);
	});
    </script>
  </body>
</html>